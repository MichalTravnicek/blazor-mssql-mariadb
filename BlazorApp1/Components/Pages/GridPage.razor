@page "/grid"
@rendermode InteractiveServer
@layout TelerikLayout

@using System.Data
@using BlazorApp1.Components.Layout
@using BlazorApp1.Data.Vendor
@using BlazorApp1.Models
@using Telerik.DataSource.Extensions
@using Telerik.DataSource;
@using Telerik.SvgIcons

@inject IDatabaseVendor DataService

<TelerikRootComponent>
    Selected table: @selectedTable
    <br />
    <TelerikComboBox Data="@tablesData" @bind-Value="selectedTable" OnChange="@SelectedTableHandler"
                     Placeholder="Select table..." Filterable="true" Width="14em">
    </TelerikComboBox>

    @code {
        IEnumerable<string> tablesData = new List<string>();

        string selectedTable { get; set; }
        
        private void SelectedTableHandler(object obj)
        {
            Console.WriteLine("Selected table:" + obj);
            TableName = (string) obj;
            LoadData();
            GridRef.Rebind();
        }

    }    
    <TelerikGrid TItem="Dictionary<string, object>"
                 OnUpdate="@UpdateHandler"
                 OnDelete="@DeleteHandler"
                 OnCreate="@CreateHandler"
                 ConfirmDelete="true"
                 Pageable="true"
                 Groupable="true"
                 Sortable="true"
                 FilterMode="GridFilterMode.FilterMenu"
                 Resizable="true"
                 Reorderable="true"
                 EditMode="GridEditMode.Popup"
                 SelectionMode="GridSelectionMode.Multiple"
                 OnStateInit="@(args => OnStateInit(args))"
                 PageSize="10"
                 @ref="@GridRef"
                 OnRead="@ReadItems"
                 Navigable="true">
        <GridColumns>

            @foreach (var column in GetColumns())
            {
                {
                    <GridColumn Field="@column.Key" Title=@column.Key FieldType="column.Value.Type" 
                                Editable="!column.Value.IsId" Width="170px"/>
                }
            }
            <GridCommandColumn Width="260px">
                <GridCommandButton Command="Edit" Icon="@SvgIcon.Pencil" ThemeColor="@ThemeConstants.Button.ThemeColor.Primary">Edit</GridCommandButton>
                <GridCommandButton Command="Delete" Icon="@SvgIcon.Trash">Delete</GridCommandButton>
            </GridCommandColumn>
        </GridColumns>
        <GridToolBarTemplate>
            <GridCommandButton Command="Add" Icon="@SvgIcon.Plus">Add new item</GridCommandButton>
        </GridToolBarTemplate>
    </TelerikGrid>


    @code {
        DataTable DataTable { get; set; }
        List<GenericEntity> DataEntities { get; set; }
        TelerikGrid<Dictionary<string, object>> GridRef { get; set; }
        string TableName { get; set; } = "";
        
        protected override void OnInitialized()
        {
            var allTables = DataService.GetAllTables();
            tablesData = allTables;
            selectedTable = allTables[0];
            TableName = selectedTable;
            LoadData();
        }

        private void LoadData()
        {
            DataEntities = DataService.GetAll(TableName);
            DataTable = GetData();
        }
        
        private IEnumerable<KeyValuePair<string, GenericEntity.ColumnInfo>> GetColumns()
        {
            return DataEntities.First().ColumnsInfo();
        }

        public DataTable GetData()
        {
            return DataEntities.ToDataTable();
        }

        protected void ReadItems(GridReadEventArgs args)
        {
            Console.WriteLine("Reading data");
            var datasourceResult = DataTable.ToDataSourceResult(args.Request);
            args.Data = (datasourceResult.Data as IEnumerable<Dictionary<string, object>>)
                .Select(x => x.ToDictionary(
                    x => x.Key,
                    x => x.Value == DBNull.Value ? null : x.Value))
                .ToList();
            args.Total = datasourceResult.Total;
            Console.WriteLine("Total:" + args.Total);
        }

        private void OnStateInit(GridStateEventArgs<Dictionary<string, object>> args)
        {
            
        }
        public void CreateHandler(GridCommandEventArgs args)
        {
            var model = (Dictionary<string, object>) args.Item;
            var entity = model.ToEntity(DataService.GetEmpty(TableName));
            DataService.CreateOne(entity);
            LoadData();
        }

        public void UpdateHandler(GridCommandEventArgs args)
        {
            var model = (Dictionary<string, object>) args.Item;
            var entity = model.ToEntity(DataService.GetEmpty(TableName));
            DataService.UpdateOne(entity);
            LoadData();
        }

        public void DeleteHandler(GridCommandEventArgs args)
        {
            var model = (Dictionary<string, object>) args.Item;
            var entity = model.ToEntity(DataService.GetEmpty(TableName));
            DataService.DeleteOne(entity);
            LoadData();
        }

    }

    <style>
    .width-100 {
        width: 100%;
    }
    .grid .k-grid-content tr {
        line-height: 32px;
    }
</style>
</TelerikRootComponent>